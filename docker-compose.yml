services:
  zookeeper:
    image: zookeeper
    container_name: zookeeper
    networks:
      storm_network:
    # Add this volume to the zookeeper service in docker-compose.yml
    volumes:
      - ./storm/config/zoo.cfg:/apache-zookeeper-3.9.2-bin/conf/zoo.cfg


  nimbus:
    image: storm
    container_name: nimbus
    command: storm nimbus
    volumes:
      - ./storm/config/storm-nimbus.yaml:/conf/storm.yaml
      - ./target/Storm-IOTdata-1.0-SNAPSHOT-jar-with-dependencies.jar:/target/Storm-IOTdata-1.0-SNAPSHOT-jar-with-dependencies.jar
    networks:
      storm_network:
    ports:
      - 6627:6627
      

  supervisor:
    image: storm
    container_name: supervisor
    command: storm supervisor
    volumes:
      - ./storm/config/storm-nimbus.yaml:/conf/storm.yaml
    networks:
      storm_network:

  ui:
    image: storm
    container_name: ui
    command: storm ui
    volumes:
      - ./storm/config/storm-nimbus.yaml:/conf/storm.yaml
    networks:
      storm_network:
    ports:
      - 8081:8081
  
  mqtt-broker:
    image: mr4x2/mqtt-broker-iotdata:v1
    container_name: mqtt-broker
    networks:
      storm_network:
    ports:
      - 1883:1883
  
  mysql:
      image: mysql:8.0
      command:
      - --default-authentication-plugin=mysql_native_password
      # - --performance-schema-instrument=statement/%=ON
      # - --performance-schema-consumer-statements-digest=ON
      environment:
        MYSQL_ROOT_PASSWORD: SuperSecr3t
        MYSQL_DATABASE: iotdata
        MYSQL_USER: user1
        MYSQL_PASSWORD: Uet123
      ports:
      - 3306:3306
      - 33060:33060
      volumes:
      - ./sample/:/docker-entrypoint-initdb.d/
      - mysql_8:/var/lib/mysql


  webapp:
    image: duongtm3102/iot-data-api:v1
    container_name: iot-data-api
    networks:
      storm_network:
    ports:
      - 9000:9000
    volumes:
      - ./webapp/cred.json:/opt/app/cred.json
    depends_on:
      - mysql
    restart: always


networks:
  storm_network:
    driver: bridge
volumes:
  mysql_8:
